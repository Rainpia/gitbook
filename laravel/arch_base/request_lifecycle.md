# Request Lifecycle

* [介绍](#介绍)
* [生命周期概览](#生命周期概览)
  * [第一步](#第一步)
  * [HTTP/Console Kernels](#httpconsole-kernels)
  * [服务供应](#服务供应)
  * [请求分发](#请求分发)
* [关注服务供应](#关注服务供应)

## 介绍

现实生活中，我们使用工具的时候，我们对工具的原理越了解就会越自信。软件开发也不例外。我们越是了解我们使用的开发工具，在开发过程中就会越轻松自信。

这个系列文档的目的就是帮助我们在整体上了解`Laravel`框架是怎么工作的。通过整体上了解框架的结构和作用原理，在开发过程中将会更加的从容。现在不了解也不用灰心，接下来随着对`Laravel`框架的探索，我们会逐步加深我们的理解和对框架的认知。

## 生命周期概览

### 第一步

`Laravel` 应用的所有请求入口都在`public/index.php`文件中。所有的请求都通过WEB服务器直接转发到这个文件。`index.php`文件并没有包含多少代码，只是加载整个框架的入口（这也是我觉得laravel框架重的一个原因，在大多数的场景下都不需要每次加载整个框架的中间件和服务）。

`index.php`首先加载`composer`生成的自动加载文件，然后从`bootstrap/app.php`文件创建一个应用实例。框架做的第一件事就是初始化一个应用实例，也就是服务容器。

### HTTP/Console Kernels

接下来，达到的请求是要发送到 `HTTP Kernels` 还是 `Console Kernels`由请求的类型来决定。所有的请求都会通过这两种方式来处理。目前，我们先聚焦到 `HTTP Kernels`，可以在`app/Http/Kernel.php`中找到源码。

`HTTP Kernel`继承了`Illuminate\Foundation\Http\Kernel`类，`Kernel`基类中定义了需要初始化的组件，并且会在请求处理之前初始化。初始化组件中包含了错误处理，日志配置，环境检测等需要在请求正式处理之前需要依赖的组件。

`HTTP Kernel` 中也定义了请求正式传递给应用前，必须通过的 `HTTP` 中间件。这些中间件会完成 `HTTP Session` 的读和写，决定程序是不是运行在调试模式，验证跨站访问的 `CSRF Token`，等。

`HTTP`的 `handle` 方法定义也很简单：接受一个`Request`对象，返回一个`Response`对象。可以把`Kernel`当作一个表示应用程序的黑盒子，给一个`HTTP`输入，返回一个`HTTP`输出。

### 服务供应

应用内核加载操作中，最重要的一步就是初始化服务供应。应用中所有的服务供应都在`config/app.php`文件中`$provider`数组中定义。初始化服务过程中，首先会调用服务器中的`register`方法，然后，当所有的服务都注册完成之后，会调用服务的`boot`方法。

服务供应会负责注册应用所需要的各种组件，比如数据库，队列，验证，路由。在所有框架必须的启动引导和配置都配置完成的情况下，服务供应的启动过程是`laravel`应用中最用要的一步操作。

### 请求分发

现在，应用所有的启动引导都已完成，服务供应都已注册完成，`Request`请求将交给路由来分发。路由器会将请求分发到一个路由或者一个控制器，并运行特定路由的中间件。

## 关注服务供应

服务供应是启动引导`Laravel` 应用的关键。创建应用实例，注册服务供应，请求转发给应用。就是这么简单（要看源码）。

能够宏观粗略的了解`laravel`应用服务供应的构建和引导流程是十分必要的。应用默认的服务都放在`app/Providers`目录下。

默认的，`AppServiceProvider`文件是空的，这里可以添加应用自定义的服务和服务的绑定关系。对于大型应用，最好按需要的粒度将服务拆分成多个文件。
